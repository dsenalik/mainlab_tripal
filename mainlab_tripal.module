<?php

/**
 * @defgroup mainlab_tripal Library
 * @{
 * Provides functions for display and management of data in custom tables
 * @}
 * @ingroup tripal_modules
 */

require_once "includes/custom_schema.inc";



/**
 * Provide information to drupal about the node types that we're creating
 * in this module
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_node_info() {
  $nodes = array();

  return $nodes;
}

/**
 * Set the permission types that the chado module uses.  Essentially we
 * want permissionis that protect creation, editing and deleting of chado
 * data objects
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_perm() {
  return array(

  );
}
/**
 * Menu items are automatically added for the new node types created
 * by this module to the 'Create Content' Navigation menu item.  This function
 * adds more menu items needed for this module.
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_menu() {
  $items = array();
  

  return $items;
}

/**
 * Implements hook_views_api()
 * Purpose: Essentially this hook tells drupal that there is views support for
 *  for this module which then includes tripal_db.views.inc where all the
 *  views integration code is
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_views_api() {
  return array(
    'api' => 2.0,
  );
}


/**
 * Administrative settings form
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_admin() {
  $form = array();



  return system_settings_form($form);
}

/**
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_admin_validate($form, &$form_state) {
 
}

/**
 * Implementation of hook_nodeapi().
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_nodeapi(&$node, $op, $teaser, $page) {

 
}

/**
 *  We need to let drupal know about our theme functions and their arguments.
 *  We create theme functions to allow users of the module to customize the
 *  look and feel of the output generated in this module
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_theme() {
	$path = drupal_get_path('module', 'mainlab_tripal') . '/theme';
	
  $themes = array(
    'tripal_organism_relationships' => array(
      'arguments' => array('node' => NULL),
      'template' => 'tripal_organism_relationships',
      'path' => $path . '/tripal_organism',    
    ),
    'tripal_organism_properties' => array(
      'arguments' => array('node' => NULL),
      'template' => 'tripal_organism_properties',
      'path' => $path . '/tripal_organism',    
    ),
    'tripal_organism_maps' => array(
      'arguments' => array('node' => NULL),
      'template' => 'tripal_organism_maps',
      'path' => $path . '/tripal_organism',    
    ),
  	'tripal_feature_publication' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_feature_publication',
  			'path' => $path . '/tripal_feature',
  	),
  	'tripal_feature_contact' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_feature_contact',
  			'path' => $path . '/tripal_feature',
  	),
  	'tripal_feature_genetic_marker' => array(
  				'arguments' => array('node' => NULL),
  				'template' => 'tripal_feature_genetic_marker',
  				'path' => $path . '/tripal_feature',
  	),
  	'tripal_feature_genetic_marker_map_positions' => array(
  		'arguments' => array('node' => NULL),
  		'template' => 'tripal_feature_genetic_marker_map_positions',
  		'path' => $path . '/tripal_feature',
  	 ),
  	'tripal_feature_genetic_marker_polymorphism' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_feature_genetic_marker_polymorphism',
  			'path' => $path . '/tripal_feature',
  	),
  	 'tripal_feature_sequence_feature' => array(
  				'arguments' => array('node' => NULL),
  				'template' => 'tripal_feature_sequence_feature',
  				'path' => $path . '/tripal_feature',
  	 ),
  	'tripal_featuremap_base_custom' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_featuremap_base_custom',
  			'path' => $path . '/tripal_featuremap',
  	),
  	'tripal_featuremap_stock' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_featuremap_stock',
  			'path' => $path . '/tripal_featuremap',
  	),
  	'tripal_featuremap_publication' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_featuremap_publication',
  			'path' => $path . '/tripal_featuremap',
  	),
  	'tripal_featuremap_contact' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_featuremap_contact',
  			'path' => $path . '/tripal_featuremap',
  	),
  );
  return $themes;
}


/**
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_cron() {

}

/**
 *
 *
 * @ingroup tripal_organism
 */
function tripal_organism_preprocess_tripal_organism_relationships(&$variables) {
  // we want to provide a new variable that contains the matched organisms.
  $organism = $variables['node']->organism;
  
  // normally we would use tripal_core_expand_chado_vars to expand our
  // organism object and add in the relationships, however whan a large
  // number of relationships are present this significantly slows the
  // query, therefore we will manually perform the query
  $sql = "
    SELECT O.genus, O.species, O.organism_id, CO.nid, CVT.name as rel_type
    FROM organism_relationship ORel
      INNER JOIN organism O on ORel.object_organism_id = O.organism_id
      INNER JOIN cvterm CVT on ORel.type_id = CVT.cvterm_id
      LEFT JOIN chado_organism CO on O.organism_id = CO.organism_id
    WHERE ORel.subject_organism_id = %d      
  ";
  $as_subject = chado_query($sql,$organism->organism_id);
  $sql = "
    SELECT O.genus, O.species, O.organism_id, CO.nid, CVT.name as rel_type
    FROM organism_relationship ORel
      INNER JOIN organism O on ORel.subject_organism_id = O.organism_id
      INNER JOIN cvterm CVT on ORel.type_id = CVT.cvterm_id
      LEFT JOIN chado_organism CO on O.organism_id = CO.organism_id
    WHERE ORel.object_organism_id = %d      
  ";
  $as_object = chado_query($sql,$organism->organism_id);   
  
  // combine both object and subject relationshisp into a single array
  $relationships = array();
  $relationships['object'] = array();
  $relationships['subject'] = array();
  
   // iterate through the object relationships
   while ($relationship = db_fetch_object($as_object)) {
    
     // get the relationship and child types
     $rel_type = t(preg_replace('/_/'," ",$relationship->rel_type));     

     if (!array_key_exists($rel_type, $relationships['object'])) {
       $relationships['object'][$rel_type] = array();   
     }  
     $relationships['object'][$rel_type][] = $relationship;  
  }
  
   while ($relationship = db_fetch_object($as_subject)) {
    
     // get the relationship and child types
     $rel_type = t(preg_replace('/_/'," ",$relationship->rel_type));     

     if (!array_key_exists($rel_type, $relationships['subject'])) {
       $relationships['subject'][$rel_type] = array();   
     }  
     $relationships['subject'][$rel_type][] = $relationship;  
  } 
  
  $organism->all_relationships = $relationships;

}

/**
 *
 *
 * @ingroup tripal_feature
 */
function tripal_feature_preprocess_tripal_feature_genetic_marker_map_positions(&$variables) {
	$feature = $variables['node']->feature;
   // get map positions
   $results = chado_query(
   "SELECT nid, FM.name, locus_name, locus_start, linkage_group, genome 
	  FROM search_by_map_locus SBML 
     INNER JOIN featuremap FM ON SBML.featuremap_id = FM.featuremap_id
     INNER JOIN chado_featuremap CF ON SBML.featuremap_id = CF.featuremap_id
     WHERE locus_feature_id IN 
	  (SELECT feature_id 
		   FROM feature F 
		   INNER JOIN feature_relationship FR ON F.feature_id = FR.subject_id 
		   WHERE F.type_id =	(SELECT cvterm_id FROM cvterm WHERE name = 'marker_locus')
		   AND FR.type_id = (SELECT cvterm_id FROM cvterm WHERE name = 'instance_of') 
         AND FR.object_id = %d)", $feature->feature_id);
   $positions = array ();
   $counter = 0;
   while ($pos = db_fetch_object($results)) {
   	$positions [$counter] = $pos;
   	$counter ++;
   }
   $feature->map_positions = $positions;
}

/**
 *
 *
 * @ingroup tripal_featuremap
 */
function tripal_featuremap_preprocess_tripal_featuremap_base_custom(&$variables) {
	$featuremap = $variables['node']->featuremap;
	$num_loci = db_result(chado_query(
			"SELECT count (distinct F.uniquename) 
			  FROM featurepos FP 
			  INNER JOIN feature F ON F.feature_id = FP.feature_id 
			  WHERE F.type_id = (SELECT cvterm_id 
			                                      FROM cvterm 
			                                      WHERE name = 'marker_locus') 
			  AND featuremap_id = %d", $featuremap->featuremap_id));
	$num_lg = db_result(chado_query(
			"SELECT count (distinct F.uniquename) 
			  FROM featurepos FP 
			  INNER JOIN feature F ON F.feature_id = FP.map_feature_id 
			  WHERE F.type_id = (SELECT cvterm_id 
			                                      FROM cvterm 
			                                      WHERE name = 'linkage_group') 
			  AND featuremap_id = %d", $featuremap->featuremap_id));
	
	$featuremap->num_loci = $num_loci;
	$featuremap->num_lg = $num_lg;
}