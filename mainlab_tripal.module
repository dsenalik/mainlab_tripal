<?php

/**
 * @defgroup mainlab_tripal Library
 * @{
 * Provides functions for display and management of data in custom tables
 * @}
 * @ingroup tripal_modules
 */

require_once "includes/custom_schema.inc";
require_once "includes/qtl_details.inc";
require_once "includes/custom_search.inc";
require_once "includes/simple_seq_extract.inc";
require_once "includes/stock_listing.page.inc";

/**
 *
 * @ingroup tripal_feature
 */
function mainlab_tripal_init() {
  drupal_add_css(drupal_get_path('module', 'mainlab_tripal') . '/theme/mainlab/css/mainlab_tripal.css');
}

/**
 * Provide information to drupal about the node types that we're creating
 * in this module
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_node_info() {
  $nodes = array();

  return $nodes;
}

/**
 * Set the permission types that the chado module uses.  Essentially we
 * want permissionis that protect creation, editing and deleting of chado
 * data objects
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_perm() {
  return array(

  );
}
/**
 * Menu items are automatically added for the new node types created
 * by this module to the 'Create Content' Navigation menu item.  This function
 * adds more menu items needed for this module.
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_menu() {
  $items = array();

  // the custom sequence retrieval form
  $items['retrieve/sequences'] = array(
    'title' => 'Sequence Retrieval',
    'description' => 'Download a file of sequences',
    'page callback' => 'mainlab_tripal_seq_extract_page',
    'access arguments' => array('access chado_feature content'),
    'type' => MENU_CALLBACK,
  );
  

  // The polymorphism page
  $items['polymorphism/%'] = array(
  		'title' => 'Polymorphism',
  		'page callback' => 'mainlab_show_polymorphism',
  		'page arguments' => array(1),
  		'access arguments' => array('access content'),
  		'file' => 'includes/polymorphism.page.inc',
  		'type' => MENU_CALLBACK
  );
  // The allele page
  $items['allele/%/%/%'] = array(
  		'title' => 'Allele',
  		'page callback' => 'mainlab_show_allele',
  		'page arguments' => array(1,2,3),
  		'access arguments' => array('access content'),
  		'file' => 'includes/allele.page.inc',
  		'type' => MENU_CALLBACK
  );
  
  if (mainlab_tripal_get_site() == 'gdr') {
  	$items['polymorphism/%']['file'] = 'includes/gdr_polymorphism.page.inc';
  	$items['allele/%/%/%']['file'] = 'includes/gdr_allele.page.inc';
  }
  
  // The sequence listing page
  $items['feature_listing/%/%/%'] = array(
  		'title' => 'Sequences',
  		'page callback' => 'mainlab_feature_listing',
  		'page arguments' => array(1,2,3),
  		'access arguments' => array('access content'),
  		'file' => 'includes/feature_listing.page.inc',
  		'type' => MENU_CALLBACK
  );
  // Switching page for the stock listing
  $items['stock_listing_page/%/%'] = array(
  		'page callback' => 'mainlab_stock_listing_switch_page',
  		'page arguments' => array(1,2),
  		'access arguments' => array('access content'),
  		'type' => MENU_CALLBACK
  );
  
  // Replicate Tripal Pub Search URLs
  $items['search/publications' ]= array(
      'title' => 'Publication Search',
      'description' => ('Search for publications'),
      'page callback' => 'tripal_pub_search_page',
      'access arguments' => array('access chado_pub content'),
      'type' => MENU_CALLBACK
  );  
  $items['search/publications/criteria/%/%'] = array(
      'page callback' => 'tripal_pub_search_page_update_criteria',
      'page arguments' => array(5, 6),
      'access arguments' => array('access chado_pub content'),
      'type ' => MENU_CALLBACK,
  );
  
  return $items;
}

/**
 * Implements hook_views_api()
 * Purpose: Essentially this hook tells drupal that there is views support for
 *  for this module which then includes tripal_db.views.inc where all the
 *  views integration code is
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_views_api() {
  return array(
    'api' => 2.0,
  );
}


/**
 * Administrative settings form
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_admin() {
  $form = array();



  return system_settings_form($form);
}

/**
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_admin_validate($form, &$form_state) {
 
}

/**
 * Implementation of hook_nodeapi().
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_nodeapi(&$node, $op, $teaser, $page) {
	// Synchronizing libraries from Chado to Drupal

 
}

/**
 *  We need to let drupal know about our theme functions and their arguments.
 *  We create theme functions to allow users of the module to customize the
 *  look and feel of the output generated in this module
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_theme() {
	$path = drupal_get_path('module', 'mainlab_tripal') . '/theme';
	
  $themes = array(
    'tripal_organism_relationships' => array(
      'arguments' => array('node' => NULL),
      'template' => 'tripal_organism_relationships',
      'path' => $path . '/tripal_organism',    
    ),
    'tripal_organism_properties' => array(
      'arguments' => array('node' => NULL),
      'template' => 'tripal_organism_properties',
      'path' => $path . '/tripal_organism',    
    ),
    'tripal_organism_maps' => array(
      'arguments' => array('node' => NULL),
      'template' => 'tripal_organism_maps',
      'path' => $path . '/tripal_organism',    
    ),
  	'tripal_feature_publication' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_feature_publication',
  			'path' => $path . '/tripal_feature',
  	),
  	'tripal_feature_contact' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_feature_contact',
  			'path' => $path . '/tripal_feature',
  	),
  	'tripal_feature_genetic_marker' => array(
  				'arguments' => array('node' => NULL),
  				'template' => 'tripal_feature_genetic_marker',
  				'path' => $path . '/tripal_feature',
  	),
  	'tripal_feature_genetic_marker_map_positions' => array(
  		'arguments' => array('node' => NULL),
  		'template' => 'tripal_feature_genetic_marker_map_positions',
  		'path' => $path . '/tripal_feature',
  	 ),
  	 'tripal_feature_sequence_feature' => array(
  				'arguments' => array('node' => NULL),
  				'template' => 'tripal_feature_sequence_feature',
  				'path' => $path . '/tripal_feature',
  	 ),
  	'tripal_featuremap_base_custom' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_featuremap_base_custom',
  			'path' => $path . '/tripal_featuremap',
  	),
  	'tripal_featuremap_stock' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_featuremap_stock',
  			'path' => $path . '/tripal_featuremap',
  	),
  	'tripal_featuremap_publication' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_featuremap_publication',
  			'path' => $path . '/tripal_featuremap',
  	),
  	'tripal_featuremap_contact' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_featuremap_contact',
  			'path' => $path . '/tripal_featuremap',
  	),
  	'mainlab_polymorphism' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'mainlab_polymorphism',
  			'path' => $path . '/mainlab',
  	),
  	'mainlab_allele' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'mainlab_allele',
  			'path' => $path . '/mainlab',
  	),
 	'gdr_mainlab_polymorphism' => array(
 			'arguments' => array('node' => NULL),
 			'template' => 'gdr_mainlab_polymorphism',
 			'path' => $path . '/mainlab',
 	),
 	'gdr_mainlab_allele' => array(
 			'arguments' => array('node' => NULL),
 			'template' => 'gdr_mainlab_allele',
 			'path' => $path . '/mainlab',
 	),
  	'tripal_stock_maternal_parent' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_stock_maternal_parent',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_paternal_parent' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_stock_paternal_parent',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_trait_scores' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_stock_trait_scores',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_genotypic_data' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_stock_genotypic_data',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_in_collection' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_stock_in_collection',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_population_map' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_stock_population_map',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_image' => array(
  			'arguments' => array('node' => NULL),
  			'template' => 'tripal_stock_image',
  			'path' => $path . '/tripal_stock',
  	),

    // themed forms
    'mainlab_tripal_seq_extract_form' => array(
       'arguments' => array('form'),
    )
  );
  return $themes;
}


/**
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_cron() {

}

/**
 *
 *
 * @ingroup tripal_organism
 */
function tripal_organism_preprocess_tripal_organism_relationships(&$variables) {
  // we want to provide a new variable that contains the matched organisms.
  $organism = $variables['node']->organism;
  
  // normally we would use tripal_core_expand_chado_vars to expand our
  // organism object and add in the relationships, however whan a large
  // number of relationships are present this significantly slows the
  // query, therefore we will manually perform the query
  $sql = "
    SELECT O.genus, O.species, O.organism_id, CO.nid, CVT.name as rel_type
    FROM {organism_relationship} ORel
      INNER JOIN organism O on ORel.object_organism_id = O.organism_id
      INNER JOIN cvterm CVT on ORel.type_id = CVT.cvterm_id
      LEFT JOIN chado_organism CO on O.organism_id = CO.organism_id
    WHERE ORel.subject_organism_id = %d      
  ";
  $as_subject = chado_query($sql,$organism->organism_id);
  $sql = "
    SELECT O.genus, O.species, O.organism_id, CO.nid, CVT.name as rel_type
    FROM organism_relationship ORel
      INNER JOIN organism O on ORel.subject_organism_id = O.organism_id
      INNER JOIN cvterm CVT on ORel.type_id = CVT.cvterm_id
      LEFT JOIN chado_organism CO on O.organism_id = CO.organism_id
    WHERE ORel.object_organism_id = %d      
  ";
  $as_object = chado_query($sql,$organism->organism_id);   
  
  // combine both object and subject relationshisp into a single array
  $relationships = array();
  $relationships['object'] = array();
  $relationships['subject'] = array();
  
   // iterate through the object relationships
   while ($relationship = db_fetch_object($as_object)) {
    
     // get the relationship and child types
     $rel_type = t(preg_replace('/_/'," ",$relationship->rel_type));     

     if (!array_key_exists($rel_type, $relationships['object'])) {
       $relationships['object'][$rel_type] = array();   
     }  
     $relationships['object'][$rel_type][] = $relationship;  
  }
  
   while ($relationship = db_fetch_object($as_subject)) {
    
     // get the relationship and child types
     $rel_type = t(preg_replace('/_/'," ",$relationship->rel_type));     

     if (!array_key_exists($rel_type, $relationships['subject'])) {
       $relationships['subject'][$rel_type] = array();   
     }  
     $relationships['subject'][$rel_type][] = $relationship;  
  } 
  
  $organism->all_relationships = $relationships;

}

/**
 *
 *
 * @ingroup tripal_feature
 */
function tripal_feature_preprocess_tripal_feature_genetic_marker_map_positions(&$variables) {
	$feature = $variables['node']->feature;
   // get map positions
   $results = chado_query(
   "SELECT 
      CF.nid AS nid,
      FM.name AS name,
   	  X.accession,
   	  DB.urlprefix,
      LG.name AS linkage_group,
      BIN.name AS bin,
      LGP.value AS chr,
      FPP.value AS locus_start,
      LOCUS.uniquename AS locus_name
    FROM feature LOCUS
    INNER JOIN feature_relationship FR ON FR.subject_id = LOCUS.feature_id
    INNER JOIN featurepos FP ON LOCUS.feature_id = FP.feature_id
    INNER JOIN featuremap FM ON FP.featuremap_id = FM.featuremap_id
   	LEFT JOIN featuremap_dbxref FD ON FP.featuremap_id = FD.featuremap_id
   	LEFT JOIN dbxref X ON FD.dbxref_id = X.dbxref_id
   	LEFT JOIN db ON db.db_id = X.db_id
    INNER JOIN feature LG ON FP.map_feature_id = LG.feature_id
    LEFT JOIN 
     (SELECT * FROM featureprop WHERE type_id = 
      (SELECT cvterm_id
       FROM cvterm
       WHERE name = 'chr_number'
       AND cv_id = (SELECT cv_id FROM cv WHERE name = 'MAIN') 
      )
     )LGP ON LG.feature_id = LGP.feature_id
    INNER JOIN featureposprop FPP ON FP.featurepos_id = FPP.featurepos_id
    LEFT JOIN 
     (SELECT F2.name, FR2.subject_id FROM feature F2
      INNER JOIN feature_relationship FR2 ON FR2.object_id = F2.feature_id
   	WHERE FR2.type_id = 
   	  (SELECT cvterm_id FROM cvterm WHERE name = 'located_in' AND cv_id = (SELECT cv_id FROM cv WHERE name = 'relationship'))   		
     ) BIN ON LOCUS.feature_id = BIN.subject_id
    LEFT JOIN public.chado_featuremap CF ON FM.featuremap_id = CF.featuremap_id
    WHERE FR.type_id = 
     (SELECT cvterm_id 
      FROM cvterm
      WHERE name = 'instance_of'
   	AND cv_id = (SELECT cv_id FROM cv WHERE name = 'relationship') 
     )
    AND LOCUS.type_id = 
     (SELECT cvterm_id
      FROM cvterm
      WHERE name = 'marker_locus'
   	AND cv_id = (SELECT cv_id FROM cv WHERE name = 'sequence') 
     )
    AND FPP.type_id =
     (SELECT cvterm_id
      FROM cvterm
      WHERE name = 'start'
   	AND cv_id = (SELECT cv_id FROM cv WHERE name = 'MAIN') 
     )

    AND FR.object_id = %d", $feature->feature_id);
   $positions = array ();
   $counter = 0;
   while ($pos = db_fetch_object($results)) {
   	$positions [$counter] = $pos;
   	$counter ++;
   }
   $feature->map_positions = $positions;
}

/**
 * @ingroup tripal_featuremap
 */
function tripal_featuremap_preprocess_tripal_featuremap_base_custom(&$variables) {
	$featuremap = $variables['node']->featuremap;
	$num_loci = db_result(chado_query(
			"SELECT count (distinct F.uniquename) 
			  FROM {featurepos} FP 
			  INNER JOIN {feature} F ON F.feature_id = FP.feature_id 
			  WHERE F.type_id = (SELECT cvterm_id 
			                                      FROM {cvterm} 
			                                      WHERE name = 'marker_locus' AND cv_id = (SELECT cv_id FROM {cv} WHERE name = 'sequence')) 
			  AND featuremap_id = %d", $featuremap->featuremap_id));
	$num_lg = db_result(chado_query(
			"SELECT count (distinct F.uniquename) 
			  FROM {featurepos} FP 
			  INNER JOIN {feature} F ON F.feature_id = FP.map_feature_id 
			  WHERE F.type_id = (SELECT cvterm_id 
			                                      FROM {cvterm} 
			                                      WHERE name = 'linkage_group' AND cv_id = (SELECT cv_id FROM {cv} WHERE name = 'sequence')) 
			  AND featuremap_id = %d", $featuremap->featuremap_id));
	$cmap_r = chado_query(
			"SELECT db.urlprefix, X.accession 
			 FROM {featuremap_dbxref} FD
			 INNER JOIN {dbxref} X ON FD.dbxref_id = X.dbxref_id
			 INNER JOIN {db} ON db.db_id = X.db_id
			 WHERE featuremap_id = %d
			", $featuremap->featuremap_id);
	$cmap = db_fetch_object($cmap_r);
	$cmap_url = $cmap->urlprefix . $cmap->accession;
	
	$featuremap->num_loci = $num_loci;
	$featuremap->num_lg = $num_lg;
	$featuremap->cmap_url = $cmap_url;
}

/**
 * @ingroup tripal_stock
 */
function tripal_stock_preprocess_tripal_stock_maternal_parent(&$variables) {
	$stock = $variables['node']->stock;
	$results = chado_query(
			"SELECT S2.stock_id, S2.uniquename, S2.description, V.name AS type
			 FROM {stock} S1 
         INNER JOIN {stock_relationship} SR ON SR.subject_id = S1.stock_id 
         INNER JOIN {stock} S2 ON S2.stock_id = SR.object_id 
         INNER JOIN {cvterm} V ON V.cvterm_id = S2.type_id
         WHERE SR.type_id = 
         (SELECT cvterm_id 
          FROM {cvterm} 
          WHERE name = 'is_a_maternal_parent_of' AND cv_id = (SELECT cv_id FROM {cv} WHERE name = 'MAIN'))
          AND S1.stock_id = %d",  $stock->stock_id);
	$maternal_parent = NULL;
	$counter = 0;
	while ($parent = db_fetch_object($results)) {
		if (db_table_exists("chado_stock")) {
			$parent->nid = db_result(db_query("SELECT nid FROM chado_stock WHERE stock_id = %d", $parent->stock_id));
		}
		$maternal_parent[$counter] = $parent;
		$counter ++;
	}
	$stock->maternal_parent = $maternal_parent;
}

/**
 * @ingroup tripal_stock
 */
function tripal_stock_preprocess_tripal_stock_paternal_parent(&$variables) {
	$stock = $variables['node']->stock;
	$results = chado_query(
			"SELECT S2.stock_id, S2.uniquename, S2.description, V.name AS type
			 FROM {stock} S1
         INNER JOIN {stock_relationship} SR ON SR.subject_id = S1.stock_id
         INNER JOIN {stock} S2 ON S2.stock_id = SR.object_id
         INNER JOIN {cvterm} V ON V.cvterm_id = S2.type_id
         WHERE SR.type_id =
         (SELECT cvterm_id
          FROM {cvterm}
          WHERE name = 'is_a_paternal_parent_of' AND cv_id = (SELECT cv_id FROM {cv} WHERE name = 'MAIN'))
          AND S1.stock_id = %d",  $stock->stock_id);
	$paternal_parent = NULL;
	$counter = 0;
	while ($parent = db_fetch_object($results)) {
		if (db_table_exists("chado_stock")) {
			$parent->nid = db_result(db_query("SELECT nid FROM chado_stock WHERE stock_id = %d", $parent->stock_id));
		}
		$paternal_parent[$counter] = $parent;
		$counter ++;
	}
	$stock->paternal_parent = $paternal_parent;
}

/**
 * @ingroup tripal_stock
 */
function tripal_stock_preprocess_tripal_stock_trait_scores(&$variables) {
	$stock = $variables['node']->stock;
	$results = chado_query(
			"SELECT
			P.uniquename, P.value, J.name AS project
			FROM {nd_experiment_phenotype} NEP
			INNER JOIN {phenotype} P ON NEP.phenotype_id = P.phenotype_id
			INNER JOIN {nd_experiment_stock} NES ON NES.nd_experiment_id = NEP.nd_experiment_id
			INNER JOIN {nd_experiment_project} NEJ ON NES.nd_experiment_id = NEJ.nd_experiment_id
			INNER JOIN {project} J ON J.project_id = NEJ.project_id
			WHERE stock_id = %d",  $stock->stock_id);
	$trait_scores = NULL;
	$counter = 0;
	while ($traits = db_fetch_object($results)) {
		$trait_scores[$counter] = $traits;
		$counter ++;
	}
	$stock->trait_scores = $trait_scores;
}

/**
 * @ingroup tripal_stock
 */
function tripal_stock_preprocess_tripal_stock_genotypic_data(&$variables) {
	$stock = $variables['node']->stock;
	$results = chado_query(
			"SELECT
			G.uniquename, G.description, J.name AS project, F.organism_id
			FROM {nd_experiment_genotype} NEG
			INNER JOIN {genotype} G ON NEG.genotype_id = G.genotype_id
			INNER JOIN {feature_genotype} FG ON G.genotype_id = FG.genotype_id 
			INNER JOIN {feature} F ON F.feature_id = FG.feature_id 
			INNER JOIN {nd_experiment_stock} NES ON NES.nd_experiment_id = NEG.nd_experiment_id
			INNER JOIN {nd_experiment_project} NEJ ON NES.nd_experiment_id = NEJ.nd_experiment_id
			INNER JOIN {project} J ON J.project_id = NEJ.project_id
			WHERE stock_id IN 
			  (SELECT stock_id 
			   FROM {stock} S
			   INNER JOIN {stock_relationship} SR ON S.stock_id = SR.subject_id
			   WHERE SR.type_id = 
			      (SELECT cvterm_id FROM {cvterm} WHERE name = 'sample_of' AND cv_id = (SELECT cv_id FROM {cv} WHERE name = 'MAIN'))
			   AND SR.object_id = %d)",  $stock->stock_id);
	$gdata = NULL;
	$counter = 0;
	while ($gtype = db_fetch_object($results)) {
		$gdata[$counter] = $gtype;
		$counter ++;
	}
	$stock->genotypic_data = $gdata;
}

/**
 * @ingroup tripal_stock
 */
function tripal_stock_preprocess_tripal_stock_in_collection(&$variables) {
	$stock = $variables['node']->stock;
	$results = chado_query(
			"SELECT 
			max(SC.name) AS collection, 
			max(db.name) AS db,
			max(db.urlprefix) AS urlprefix,
			string_agg(X.accession, '; ') AS accession
			FROM {stockcollection} SC
			INNER JOIN {stockcollection_stock} SS ON SS.stockcollection_id = SC.stockcollection_id
			INNER JOIN {stockcollection_db} SD ON SC.stockcollection_id = SD.stockcollection_id
			INNER JOIN {db} ON db.db_id = SD.db_id
			INNER JOIN {stock_dbxref} SX ON SX.stock_id = SS.stock_id
			INNER JOIN {dbxref} X ON SX.dbxref_id = X.dbxref_id AND X.db_id = db.db_id
			WHERE SS.stock_id = %d
			GROUP BY SC.stockcollection_id
			",  $stock->stock_id);
	$coll = NULL;
	$counter = 0;
	while ($c = db_fetch_object($results)) {
		$coll[$counter] = $c;
		$counter ++;
	}
	$stock->in_collection = $coll;
}

/**
 * @ingroup tripal_stock
 */
function tripal_stock_preprocess_tripal_stock_population_map(&$variables) {
	$stock = $variables['node']->stock;
	// We want to show maps for this stock and maps of its children
	$results = chado_query(
			"SELECT 
           M.featuremap_id, 
			  M.name
           FROM {featuremap} M
           INNER JOIN {featuremap_stock} MS ON M.featuremap_id = MS.featuremap_id
           WHERE MS.stock_id = %d
           OR MS.stock_id in 
			     (SELECT SR.object_id FROM {stock} S1
               INNER JOIN {stock_relationship} SR ON S1.stock_id = SR.subject_id
               WHERE SR.type_id IN 
                  (SELECT cvterm_id 
                   FROM {cvterm} 
                   WHERE (name = 'is_a_maternal_parent_of' 
                   OR name = 'is_a_paternal_parent_of') AND cv_id = (SELECT cv_id FROM {cv} WHERE name = 'MAIN'))
               AND S1.stock_id = %d)",  $stock->stock_id,  $stock->stock_id);
	$maps = NULL;
	$counter = 0;
	while ($map = db_fetch_object($results)) {
		if (db_table_exists("chado_featuremap")) {
			$map->nid = db_result(db_query("SELECT nid FROM chado_featuremap WHERE featuremap_id = %d", $map->featuremap_id));
		}
		$map->ptype = db_result(db_query("SELECT value FROM featuremapprop WHERE type_id = (SELECT cvterm_id FROM cvterm WHERE name = 'population_type' AND cv_id = (SELECT cv_id FROM cv WHERE name = 'MAIN')) AND featuremap_id = %d", $map->featuremap_id));
		$map->ggroup = db_result(db_query("SELECT value FROM featuremapprop WHERE type_id = (SELECT cvterm_id FROM cvterm WHERE name = 'genome_group' AND cv_id = (SELECT cv_id FROM cv WHERE name = 'MAIN')) AND featuremap_id = %d", $map->featuremap_id));
		$map->mtype = db_result(db_query("SELECT value FROM featuremapprop WHERE type_id = (SELECT cvterm_id FROM cvterm WHERE name = 'map_type' AND cv_id = (SELECT cv_id FROM cv WHERE name = 'MAIN')) AND featuremap_id = %d", $map->featuremap_id));
		
		$maps[$counter] = $map;
		$counter ++;
	}
	$stock->population_map = $maps;
}

/**
 * @ingroup tripal_stock
 */
function tripal_stock_preprocess_tripal_stock_image(&$variables) {
	$stock = $variables['node']->stock;
	// We want to show maps for this stock and maps of its children
	$results = chado_query(
			"SELECT eimage_type, image_uri, value as legend 
			 FROM {stock_image} SI 
			 INNER JOIN {eimage} I ON SI.eimage_id = I.eimage_id 
			 INNER JOIN {eimageprop} IP ON I.eimage_id = IP.eimage_id 
			 WHERE IP.type_id = (SELECT cvterm_id 
			                                      FROM {cvterm} 
			                                      WHERE name = 'description' 
			                                      AND cv_id = (SELECT cv_id FROM {cv} WHERE name = 'MAIN')
			                                    )
			AND stock_id = %d", 
			$stock->stock_id);
	$images = NULL;
	$counter = 0;
	while ($img = db_fetch_object($results)) {
		$images[$counter] = $img;
		$counter ++;
	}
	$stock->images = $images;
}

function mainlab_tripal_get_site () {
	global $base_url;
	if (preg_match('/rosaceae\.org/', $base_url) || preg_match('/rosaceae\.org/', $_SERVER['PWD'])) {
		return 'gdr';
	} else if (preg_match('/cottongen\.org/', $base_url) || preg_match('/cottongen\.org/', $_SERVER['PWD'])) {
		return 'cottongen';
	} else {
		return 'unknown';
	}
}
/**
 * Hook to Tripal Pub form to add a tutorial link
 * @param unknown $form
 * @param unknown $form_state
 */
function mainlab_tripal_form_tripal_pub_search_form_alter (&$form, &$form_state) {
  $val = $form['instructions']['#value'];
  $form['instructions']['#value'] = $val . "(<a href=\"/tutorial/publication_search\"><b>Help</b></a>)";
}