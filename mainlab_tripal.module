<?php

/**
 * @defgroup mainlab_tripal Library
 * @{
 * Provides functions for display and management of data in custom tables
 * @}
 * @ingroup tripal_modules
 */

require_once "includes/custom_schema.inc";
require_once "includes/simple_seq_extract.inc";
require_once "includes/stock_listing.page.inc";

require_once 'theme/mainlab_tripal.theme.inc';

/**
 *
 * @ingroup tripal_feature
 */
function mainlab_tripal_init() {
  drupal_add_css(drupal_get_path('module', 'mainlab_tripal') . '/theme/mainlab/css/mainlab_tripal.css');
}

/**
 * Provide information to drupal about the node types that we're creating
 * in this module
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_node_info() {
  $nodes = array();

  return $nodes;
}

/**
 * Set the permission types that the chado module uses.  Essentially we
 * want permissionis that protect creation, editing and deleting of chado
 * data objects
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_perm() {
  return array(

  );
}
/**
 * Menu items are automatically added for the new node types created
 * by this module to the 'Create Content' Navigation menu item.  This function
 * adds more menu items needed for this module.
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_menu() {
  $items = array();

  // the custom sequence retrieval form
  $items['retrieve/sequences'] = array(
    'title' => 'Sequence Retrieval',
    'description' => 'Download a file of sequences',
    'page callback' => 'mainlab_tripal_seq_extract_page',
    'access arguments' => array('access chado_feature content'),
    'type' => MENU_CALLBACK,
  );
  

  // The polymorphism page
  $items['polymorphism/%'] = array(
  		'title' => 'Polymorphism',
  		'page callback' => 'mainlab_show_polymorphism',
  		'page arguments' => array(1),
  		'access arguments' => array('access content'),
  		'file' => 'includes/polymorphism.page.inc',
  		'type' => MENU_CALLBACK
  );
  // The allele page
  $items['allele/%/%/%'] = array(
  		'title' => 'Allele',
  		'page callback' => 'mainlab_show_allele',
  		'page arguments' => array(1,2,3),
  		'access arguments' => array('access content'),
  		'file' => 'includes/allele.page.inc',
  		'type' => MENU_CALLBACK
  );
  
  if (mainlab_tripal_get_site() == 'gdr') {
  	$items['polymorphism/%']['file'] = 'includes/gdr_polymorphism.page.inc';
  	$items['allele/%/%/%']['file'] = 'includes/gdr_allele.page.inc';
  }
  
  // The sequence listing page
  $items['feature_listing/%/%/%'] = array(
  		'title' => 'Sequences',
  		'page callback' => 'mainlab_feature_listing',
  		'page arguments' => array(1,2,3),
  		'access arguments' => array('access content'),
  		'file' => 'includes/feature_listing.page.inc',
  		'type' => MENU_CALLBACK
  );
  // Switching page for the stock listing
  $items['stock_listing_page/%/%'] = array(
  		'page callback' => 'mainlab_stock_listing_switch_page',
  		'page arguments' => array(1,2),
  		'access arguments' => array('access content'),
  		'type' => MENU_CALLBACK
  );
  
  // The gene class browser
  $items['gene_class_listing'] = array(
  		'page callback' => 'mainlab_gene_class_listing_page',
  		'page arguments' => array(1),
  		'access arguments' => array('access content'),
  		'type' => MENU_CALLBACK,
  		'file' => 'includes/gene_class_listing.page.inc',
  );
  
  // The gene class page
  $items['gene_class'] = array(
  		'page callback' => 'mainlab_gene_class_page',
  		'page arguments' => array(1),
  		'access arguments' => array('access content'),
  		'type' => MENU_CALLBACK,
  		'file' => 'includes/gene_class.page.inc',
  );
  
  // Replicate Tripal Pub Search URLs
  $items['search/publications' ]= array(
      'title' => 'Publication Search',
      'description' => ('Search for publications'),
      'page callback' => 'tripal_pub_search_page',
      'access arguments' => array('access chado_pub content'),
      'type' => MENU_CALLBACK
  );  
  $items['search/publications/criteria/%/%'] = array(
      'page callback' => 'tripal_pub_search_page_update_criteria',
      'page arguments' => array(5, 6),
      'access arguments' => array('access chado_pub content'),
      'type ' => MENU_CALLBACK,
  );
  
  return $items;
}

/**
 * Implements hook_views_api()
 * Purpose: Essentially this hook tells drupal that there is views support for
 *  for this module which then includes tripal_db.views.inc where all the
 *  views integration code is
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_views_api() {
  return array(
    'api' => 3.0,
  );
}


/**
 * Administrative settings form
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_admin() {
  $form = array();



  return system_settings_form($form);
}

/**
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_admin_validate($form, &$form_state) {
 
}

/**
 * Implementation of hook_nodeapi().
 *
 * @ingroup mainlab_qtl
 */
function mainlab_tripal_node_view($node, $view_mode, $langcode) {
  switch ($node->type) {
    // Feature
    case 'chado_feature' :
      if ($view_mode == 'full') {
        switch ( $node->feature->type_id->name) {
          case 'genetic_marker':
            $node->content['tripal_feature_genetic_marker'] = array(
              '#markup' => theme('tripal_feature_genetic_marker',  array('node' => $node)),
              '#tripal_toc_id'    => 'genetic_marker',
              '#tripal_toc_title' => 'Marker Overview',
              '#weight' => -100,
            );
            $node->content['tripal_feature_genetic_marker_map_positions'] = array(
              '#markup' => theme('tripal_feature_genetic_marker_map_positions',  array('node' => $node)),
              '#tripal_toc_id' => 'genetic_marker_map_position',
              '#tripal_toc_title' => 'Map Positions',
            );
            $node->content['tripal_feature_genetic_marker_contacts'] = array(
              '#markup' => theme('tripal_feature_contact',  array('node' => $node)),
              '#tripal_toc_id' => 'genetic_marker_contacts',
              '#tripal_toc_title' => 'Contacts',
            );
            break;
          case 'sequence_feature':
            $node->content['tripal_feature_sequence_feature'] = array(
              '#markup' => theme('tripal_feature_sequence_feature',  array('node' => $node)),
              '#tripal_toc_id'    => 'sequence_feature',
              '#tripal_toc_title' => 'Sequence Overview',
              '#weight' => -100,
            );
            break;
        }
      }
      break;
      // Stock
      case 'chado_stock' :
        if ($view_mode == 'full') {
            $node->content['tripal_stock_custom_base'] = array(
            '#markup' => theme('tripal_stock_custom_base',  array('node' => $node)),
            '#tripal_toc_id'    => 'germplasm',
            '#tripal_toc_title' => 'Germplasm Overview',
            '#weight' => -100,
            );
            $node->content['tripal_stock_maternal_parent'] = array(
              '#markup' => theme('tripal_stock_maternal_parent',  array('node' => $node)),
              '#tripal_toc_id'    => 'maternal_parent',
              '#tripal_toc_title' => 'Maternal Parent',
              '#weight' => -100,
            );
            $node->content['tripal_stock_paternal_parent'] = array(
              '#markup' => theme('tripal_stock_paternal_parent',  array('node' => $node)),
              '#tripal_toc_id'    => 'paternal_parent',
              '#tripal_toc_title' => 'Paternal Parent',
              '#weight' => -100,
            );
            $node->content['tripal_stock_population_map'] = array(
              '#markup' => theme('tripal_stock_population_map',  array('node' => $node)),
              '#tripal_toc_id'    => 'population_map',
              '#tripal_toc_title' => 'Map',
              '#weight' => -90,
            );
        }
  }
}

/**
 * Implementation of hook_nodeapi().
 * 
 * @ingroup mainlab_qtl
 */
function mainlab_tripal_node_view_alter(&$build) {
  $node = $build['#node'];
  // Hide default templates
  //Feature
  if (property_exists($node, 'feature')) {
    switch ($node->feature->type_id->name) {
      case 'genetic_marker':
        unset($build['tripal_feature_base']);
        unset($build['tripal_feature_properties']);
        break;
      case 'sequence_feature':
        unset($build['tripal_feature_base']);
        unset($build['tripal_feature_seqence']);
        break;
    }
  }
  // Stock
  if (property_exists($node, 'stock')) {
    unset($build['tripal_stock_base']);
    unset($build['tripal_stock_properties']);
    unset($build['tripal_stock_relationships']);
  }
  
}


/**
 *  We need to let drupal know about our theme functions and their arguments.
 *  We create theme functions to allow users of the module to customize the
 *  look and feel of the output generated in this module
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_theme($existing, $type, $theme, $path) {
	$path = drupal_get_path('module', 'mainlab_tripal') . '/theme';
	
  $themes = array(
    'tripal_organism_relationships' => array(
      'variables' => array('node' => NULL),
      'template' => 'tripal_organism_relationships',
      'path' => $path . '/tripal_organism',    
    ),
    'tripal_organism_properties' => array(
      'variables' => array('node' => NULL),
      'template' => 'tripal_organism_properties',
      'path' => $path . '/tripal_organism',    
    ),
    'tripal_organism_maps' => array(
      'variables' => array('node' => NULL),
      'template' => 'tripal_organism_maps',
      'path' => $path . '/tripal_organism',    
    ),
  	'tripal_feature_contact' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_feature_contact',
  			'path' => $path . '/tripal_feature',
  	),
  	'tripal_feature_genetic_marker' => array(
  				'variables' => array('node' => NULL),
  				'template' => 'tripal_feature_genetic_marker',
  				'path' => $path . '/tripal_feature',
  	),
  	'tripal_feature_genetic_marker_map_positions' => array(
  		'variables' => array('node' => NULL),
  		'template' => 'tripal_feature_genetic_marker_map_positions',
  		'path' => $path . '/tripal_feature',
  	 ),
     'tripal_feature_genetic_marker_image' => array(
        'variables' => array('node' => NULL),
        'template' => 'tripal_feature_genetic_marker_image',
        'path' => $path . '/tripal_feature',
     ),
  	 'tripal_feature_sequence_feature' => array(
  				'variables' => array('node' => NULL),
  				'template' => 'tripal_feature_sequence_feature',
  				'path' => $path . '/tripal_feature',
  	 ),
  	'tripal_featuremap_base_custom' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_featuremap_base_custom',
  			'path' => $path . '/tripal_featuremap',
  	),
  	'tripal_featuremap_stock' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_featuremap_stock',
  			'path' => $path . '/tripal_featuremap',
  	),
  	'tripal_featuremap_publication' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_featuremap_publication',
  			'path' => $path . '/tripal_featuremap',
  	),
  	'tripal_featuremap_contact' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_featuremap_contact',
  			'path' => $path . '/tripal_featuremap',
  	),
  	'mainlab_polymorphism' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'mainlab_polymorphism',
  			'path' => $path . '/mainlab',
  	),
  	'mainlab_allele' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'mainlab_allele',
  			'path' => $path . '/mainlab',
  	),
 	'gdr_mainlab_polymorphism' => array(
 			'variables' => array('node' => NULL),
 			'template' => 'gdr_mainlab_polymorphism',
 			'path' => $path . '/mainlab',
 	),
 	'gdr_mainlab_allele' => array(
 			'variables' => array('node' => NULL),
 			'template' => 'gdr_mainlab_allele',
 			'path' => $path . '/mainlab',
 	),
    'tripal_stock_custom_base' => array(
      'variables' => array('node' => NULL),
      'template' => 'tripal_stock_custom_base',
      'path' => $path . '/tripal_stock',
    ),
  	'tripal_stock_maternal_parent' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_stock_maternal_parent',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_paternal_parent' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_stock_paternal_parent',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_phenotypic_data' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_stock_phenotypic_data',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_genotypic_data' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_stock_genotypic_data',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_in_collection' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_stock_in_collection',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_population_map' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_stock_population_map',
  			'path' => $path . '/tripal_stock',
  	),
  	'tripal_stock_image' => array(
  			'variables' => array('node' => NULL),
  			'template' => 'tripal_stock_image',
  			'path' => $path . '/tripal_stock',
  	),
    'tripal_pub_image' => array(
        'variables' => array('node' => NULL),
        'template' => 'tripal_pub_image',
        'path' => $path . '/tripal_pub',
    ),
    // themed forms
    'mainlab_tripal_seq_extract_form' => array(
       'variables' => array('form'),
    ),
    // nd_geolocation
    'tripal_nd_geolocation_base_custom' => array(
        'variables' => array('node' => NULL),
        'template' => 'tripal_nd_geolocation_base_custom',
        'path' => $path . '/tripal_natural_diversity',
    ),
    'tripal_nd_geolocation_associated_dataset' => array(
        'variables' => array('node' => NULL),
        'template' => 'tripal_nd_geolocation_associated_dataset',
        'path' => $path . '/tripal_natural_diversity',
    ),
    // eimage
    'cottongen_tripal_eimage_base' => array(
        'variables' => array('node' => NULL),
        'template' => 'cottongen_tripal_eimage_base',
        'path' => $path . '/tripal_eimage',
    ),
    // eimage
    'tripal_eimage_contact' => array(
        'variables' => array('node' => NULL),
        'template' => 'tripal_eimage_contact',
        'path' => $path . '/tripal_eimage',
    ),
    'tripal_feature_haplotype_block' => array(
      'variables' => array('node' => NULL),
      'template' => 'tripal_feature_haplotype_block',
      'path' => $path . '/tripal_feature',
    ),
    'tripal_feature_haplotype_block_stocks' => array(
      'variables' => array('node' => NULL),
      'template' => 'tripal_feature_haplotype_block_stocks',
      'path' => $path . '/tripal_feature',
    ),
    'tripal_feature_haplotype_block_haplotypes' => array(
      'variables' => array('node' => NULL),
      'template' => 'tripal_feature_haplotype_block_haplotypes',
      'path' => $path . '/tripal_feature',
    ),
  );
  return $themes;
}


/**
 *
 * @ingroup mainlab_tripal
 */
function mainlab_tripal_cron() {

}

/**
 * Return the site name
 * @return string:
 *  'gdr' for Rosaceae Genomic Database
 *  'cottongen' for CottonGen
 */
function mainlab_tripal_get_site () {
	global $base_url;
	if (preg_match('/rosaceae\.org/', $base_url) || preg_match('/rosaceae\.org/', $_SERVER['SERVER_NAME'])) {
		return 'gdr';
	} else if (preg_match('/cottongen\.org/', $base_url) || preg_match('/cottongen\.org/', $_SERVER['SERVER_NAME'])) {
		return 'cottongen';
	} else {
		return 'unknown';
	}
}
/**
 * Hook to Tripal Pub form to add a tutorial link
 * @param unknown $form
 * @param unknown $form_state
 */
function mainlab_tripal_form_tripal_pub_search_form_alter (&$form, &$form_state) {
  $tutorial = db_query("select pid from url_alias where alias = 'tutorial/publication_search'")->fetchField();
  if ($tutorial) {
    $val = $form['instructions']['#markup'];
    $form['instructions']['#markup'] = $val . "(<a href=\"/tutorial/publication_search\"><b>Help</b></a>)";
  }
}
